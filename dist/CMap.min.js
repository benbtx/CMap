function mouseEvt(){let t=-1,e=null,a=null,s=this.options,n=s.callback,{selectedMode:i,style:o}=s.map.blocks,r={hold:!1,x:0,y:0,status:!1},l=(t,a,s)=>{if(!e)return{index:-1};const n=this.hitCtx.getImageData(t,a,1,1).data,i=`rgb(${n[0]},${n[1]},${n[2]})`,o=e.colorsHash[i]||{index:-1};o&&s(o)},h=()=>{this.translateCtx(e,this.mouseEvtData.mapX,this.mouseEvtData.mapY),this.drawAllBoundary()},c=(t,e,a)=>{n&&n.hasOwnProperty(t)&&n[t](e,a)};this.ele.addEventListener("mousemove",s=>{let n=s.offsetX*this.DPI,i=s.offsetY*this.DPI;if(!this.inAnimate)if(t!==this.history.index&&(t=this.history.index,e=this.history.map[t],a=e.blocks,this.mouseEvtData={mapX:e.mapTranslateX,mapY:e.mapTranslateY}),s.buttons&&r.hold){let t=n-r.x+e.mapTranslateX,a=i-r.y+e.mapTranslateY;(this.mouseEvtData.mapX-t||this.mouseEvtData.mapY-a)&&(this.mouseEvtData.mapX=t,this.mouseEvtData.mapY=a,r.status=!0,h())}else l(n,i,t=>{let n=e.mouseMoveIndex;t.index!==n?(n>-1&&(a[n].over=!1,h()),e.mouseMoveIndex=t.index,t.index>-1&&(t.over=!0,c("mousemove",s,t),h())):c("mousemove",s,t)})}),this.ele.addEventListener("mousedown",t=>{r.hold=!0,r.x=t.offsetX*this.DPI,r.y=t.offsetY*this.DPI}),this.ele.addEventListener("mouseup",t=>{if(r.hold=!1,r.status)r.status=!1,e.mapTranslateX=this.mouseEvtData.mapX,e.mapTranslateY=this.mouseEvtData.mapY;else{let s=t.offsetX*this.DPI,n=t.offsetY*this.DPI;l(s,n,s=>{if(-1!==s.index){if((()=>e.holdBlocks.includes(e.mouseMoveIndex))(s.index)){let t=e.holdBlocks.indexOf(s.index);e.holdBlocks.splice(t,1)}else"multiple"===i?e.holdBlocks.push(s.index):"single"===i&&(e.holdBlocks.length&&(a[e.holdBlocks[0]].style.fillStyle=o.fillStyle),e.holdBlocks=[s.index]);e.holdBlocks.forEach(t=>{a[t].style.fillStyle=o.holdColor}),h(),c("click",t,s)}})}})}var event=Object.freeze({mouseEvt:mouseEvt});function getEleInfo(){this.ele=document.querySelector(this.options.el);let{width:t,height:e}=window.getComputedStyle(this.ele);t=parseInt(t),e=parseInt(e),this.eleBCR={width:t,height:e}}function init(){this.setHistory(),this.getEleInfo(),this.appendCanvasElement(),this.setMapData(),this.mouseEvt()}function setMapData(){let t={mapScale:1,boundary:{},blocks:[],hasPoint:!1,mapTranslateX:0,mapTranslateY:0,colorsHash:{},mouseMoveIndex:-1,holdBlocks:[]};t.usrData=this.options.usrData,t.mirror=this.options.map.mirror||{},t=this.setBoundary(t),t=this.setBlocks(t),t=this.setTextName(t),t=this.getPoints(t),this.history.map[this.history.index]=t,this.setMapScale()}var init$1=Object.freeze({getEleInfo:getEleInfo,init:init,setMapData:setMapData});function stepAnimate(t){let e=new Date,a=setInterval(()=>{let s=(new Date-e)/t.duration;s>1&&(s=1);let n=t.delta(s);t.callback(n),1==s&&(clearInterval(a),t.doneback&&t.doneback())},t.delay||1e3/60)}function quadAni(t){return Math.pow(t,5)}function backAni(t){return Math.pow(t,2)*(3*t-2)}function makeEaseInOutAni(t){return function(e){return 1-t(1-e)}}function fadeIn(t=1e3,e=.3){let a=this.history.map[this.history.index];this.translateCtx(a,a.mapTranslateX,a.mapTranslateY),this.drawAllBoundary();let s=this.createTemCanvas();this.clearCanvasCtx(!0),this.inAnimate=!0,stepAnimate({duration:t,delta:makeEaseInOutAni(quadAni),callback:t=>{let a=t*e,n=a+(1-e);this.ctx.save(),this.ctx.globalAlpha=t,this.ctx.translate(this.mainCanvas.width/2*(e-a),this.mainCanvas.height/2*(e-a)),this.ctx.scale(n,n),this.clearCanvasCtx(!0),this.ctx.drawImage(s,0,0),this.ctx.restore()},doneback:()=>{this.inAnimate=!1}})}function fadeOut(t=600,e=.3){let a=this.createTemCanvas(),s=1-e;this.inAnimate=!0,stepAnimate({duration:t,delta:backAni,callback:t=>{this.ctx.save();let n=(1-t)*e+s;this.clearCanvasCtx(),this.ctx.globalAlpha=1-t,this.ctx.translate(this.mainCanvas.width/2*e*t,this.mainCanvas.height/2*e*t),this.ctx.scale(n,n),this.ctx.drawImage(a,0,0),this.ctx.restore()},doneback:()=>{this.inAnimate=!1}})}function zoomOut(t=600,e=.3){let a=this.createTemCanvas();this.inAnimate=!0,stepAnimate({duration:t,delta:backAni,callback:t=>{this.ctx.save();let s=t*e+1;this.clearCanvasCtx(),this.ctx.globalAlpha=1-t,this.ctx.translate(-this.ctxW/2*t*e,-this.ctxH/2*t*e),this.ctx.scale(s,s),this.ctx.drawImage(a,0,0),this.ctx.restore()},doneback:()=>{this.inAnimate=!1}})}function zoomIn(t=1e3,e=.3){let a=this.history.map[this.history.index];this.translateCtx(a,a.mapTranslateX,a.mapTranslateY),this.drawAllBoundary();let s=this.createTemCanvas();this.clearCanvasCtx(!0),this.inAnimate=!0,stepAnimate({duration:t,delta:makeEaseInOutAni(quadAni),callback:t=>{this.ctx.save();let a=.3-t*e+1;this.ctx.globalAlpha=t,this.ctx.translate(-this.ctxW/2*e*(1-t),-this.ctxH/2*e*(1-t)),this.ctx.scale(a,a),this.clearCanvasCtx(!0),this.ctx.drawImage(s,0,0),this.ctx.restore()},doneback:()=>{this.inAnimate=!1}})}var animate=Object.freeze({fadeIn:fadeIn,fadeOut:fadeOut,zoomOut:zoomOut,zoomIn:zoomIn});function createCanvas(){let t=document.createElement("canvas"),e=this.eleBCR.width,a=this.eleBCR.height;return this.ctxW=t.width=e*this.DPI,this.ctxH=t.height=a*this.DPI,t.style.position="absolute",t.style.width=e+"px",t.style.height=a+"px",t}function appendCanvasElement(){this.mainCanvas=this.createCanvas(),this.hitMainCanvas=this.createCanvas(),this.ctx=this.mainCanvas.getContext("2d"),this.hitCtx=this.hitMainCanvas.getContext("2d"),this.ele.appendChild(this.mainCanvas)}function createTemCanvas(t=this.ctx){let e=this.mainCanvas.width,a=this.mainCanvas.height,s=this.createCanvas(),n=t.getImageData(0,0,e,a);return s.getContext("2d").putImageData(n,0,0),s}function clearCanvasCtx(t){this.ctx.clearRect(0,0,this.ctxW,this.ctxH),t||this.hitCtx.clearRect(0,0,this.ctxW,this.ctxH)}var canvas=Object.freeze({createCanvas:createCanvas,appendCanvasElement:appendCanvasElement,createTemCanvas:createTemCanvas,clearCanvasCtx:clearCanvasCtx});function getMapDataInfo(t,e){let a=[],s=[],n={},i=[],o=t.length;for(let r=0;r<o;r++){let o=computedData(t[r],e);a.push(o.x.start,o.x.end),s.push(o.y.start,o.y.end),n=o.centroid,i.push(o.coordinates)}let r=Math.min.apply({},a),l=Math.min.apply({},s),h=Math.max.apply({},a),c=Math.max.apply({},s),d=h-r,m=c-l;return{width:d,height:m,coordinates:i,x:{start:r,end:h,center:r+d/2},y:{start:l,end:c,center:l+m/2},centroid:n}}function computedData(t,e){if(!Array.isArray(t))return console.warn("你需要传入数组!");let a=0,s=0,n=0,i=0,o=0,r=0,l=[],h=[],c=[];for(let a=0,s=t.length;a<s;a+=2){let s=e&&e.x?e.x-t[a]:t[a],n=e&&e.y?e.y-t[a+1]:t[a+1];l.push(s),h.push(n),c.push([s,n])}return n=Math.min.apply({},l),o=Math.max.apply({},l),i=Math.min.apply({},h),r=Math.max.apply({},h),{width:a=o-n,height:s=r-i,x:{center:n+a/2,start:n,end:o},y:{center:i+s/2,start:i,end:r},centroid:getCentroid(t,e),coordinates:c}}function getCentroid(t,e){let a=0,s=0,n=0,i=t.length;for(let e=0;e<i;e+=2){let i=parseFloat(t[e]),o=parseFloat(t[e+1]),r=parseFloat(t[e+2]),l=parseFloat(t[e+3]);e+3>t.length&&(r=parseFloat(t[0]),l=parseFloat(t[1]));let h=i*l-r*o;a+=h,s+=(i+r)*h,n+=(o+l)*h}let o=3*a,r=~~(s/o),l=~~(n/o);return e&&(r=e.x?e.x-r:r,l=e.y?e.y-l:l),{x:r,y:l}}function setDPIFontSize(t,e){if(t)return Object.keys(t).forEach(a=>{"font"===a&&(t[a]=(t=>{let a=t.match(/([\d\.]+)(px|em)/),s=parseFloat(a[1]),n=a[2];return t=t.replace(a[0],s*e+n)})(t[a]))}),t}function setCtxState(t,e){e.beginPath();for(let a in t)e[a]=t[a];return e}var style=Object.freeze({setDPIFontSize:setDPIFontSize,setCtxState:setCtxState});function selfStyle(t){for(let e in t)this[e]=t[e]}function getBetweenRandom(t,e){return t+e*Math.random()}function isInPolygon(t,e){let a,s,n,i=0,o=e.length;s=e[0];for(let r=1;r<=o;r++)n=e[r%o],t[0]>Math.min(s[0],n[0])&&t[0]<=Math.max(s[0],n[0])&&t[1]<=Math.max(s[1],n[1])&&s[0]!=n[0]&&(a=(t[0]-s[0])*(n[1]-s[1])/(n[0]-s[0])+s[1],(s[1]==n[1]||t[1]<=a)&&i++),s=n;return i%2!=0}function scaleCoordinates(t,e){let a=[];for(let s=0,n=t.length;s<n;s++){a[s]=[];let n=t[s];for(let t=0,i=n.length;t<i;t++)a[s].push([n[t][0]*e,n[t][1]*e])}return a}function setBoundary(t){let e=this.options.map.boundary;e=Object.assign({},e,getMapDataInfo(e.data));let{coordinates:a}=setMirror(t,e,e.data);return e.coordinates=a,this.setColorsHashID(t,e,!0),t.mapScale=Math.min(this.hitMainCanvas.width/e.width,this.hitMainCanvas.height/e.height),t.boundary=e,t.mapTranslateX=0,t.mapTranslateY=0,t}function setBlocks(t){const e=this.options.map.blocks,a=e.data;let s=e.color,n=Array.isArray(s),i=n?s.length:0;for(let o=0,r=a.length;o<r;o++){let r=a[o],l=e.style;r.style&&r.style.hasOwnProperty("block")&&(l=r.style.block),!r.style&&e.color&&(n?l.fillStyle=s[o%i]:"boolean"==typeof s&&(l.fillStyle=this.getRandomColor())),Object.assign(r.map,setMirror(t,t.boundary,r.map)),r=Object.assign({},r,r.map,{style:new selfStyle(l),index:o,over:!1,hold:!1}),this.setColorsHashID(t,r),t.blocks.push(r)}return t}function setTextName(t){let e=this.options.map.blocks.cityName;return e?(e.fixed||Object.keys(e).forEach(t=>{Object.assign(e[t],setDPIFontSize(e[t],this.DPI))}),e.hasOwnProperty("normal")?(t.blocks.forEach(t=>{t.nameStyle={normal:new selfStyle(e.normal),hover:new selfStyle(e.hover?e.hover:e.normal)}}),e.fixed=!0,t):console.warn("Don't find cityName has 'normal'")):t}function getPoints(t){let e=this.options.map.blocks.point;if(!e)return t;t.hasPoint=!0;let a=Math.min.apply({},e.r),s=Math.max.apply({},e.r),n=t=>{let e=-1,a=-1;for(;;)if(isInPolygon([e=~~getBetweenRandom(t.x.start,t.x.end),a=~~getBetweenRandom(t.y.start,t.y.end)],t.coordinates[0]))return[e,a]};return t.blocks.forEach((t,i)=>{if(e.size){let o,r=e.size,l=1,h=!1;t.blocks&&t.blocks.point&&t.blocks.point.size?(o=t.blocks.point.size,h=!0,Array.isArray(o)?(h="array",l=o.length):isNaN(o)||(l=o)):r.min!==r.max&&(l=~~getBetweenRandom(r.min,r.max)),t.point=[];for(let c=0;c<l;c++){let{x:l,y:d}=t.centroid,m={};e.fun&&(m=e.fun(i,t,this.options.usrData)),r.min!==r.max&&([l,d]=n(t));let u="",p=0;h&&"array"===h?(u="color"in o[c]?o[c].color:e.color[~~getBetweenRandom(0,e.color.length)],p="r"in o[c]?o[c].r:getBetweenRandom(a,s)):(u=e.color[~~getBetweenRandom(0,e.color.length)],p=getBetweenRandom(a,s)),(m=Object.assign({},{r:p,color:u,position:{x:l,y:d}},m)).r*=this.DPI,t.point.push(m)}}}),t}function setMapScale(t){let e=this.history,a=e.map[e.index],s=a.mapScale;e.map[e.index].mapScale=t||s,this.scaleBoundary(a),this.scaleBlocks(a),this.scalePoints(a)}function scaleBoundary(t){0===t.mapTranslateX&&(t.mapTranslateX=0-t.boundary.x.start*t.mapScale,t.mapTranslateY=0-t.boundary.y.start*t.mapScale),t.boundary._coordinates=scaleCoordinates(t.boundary.coordinates,t.mapScale)}function scaleBlocks(t){for(let e=0,a=t.blocks.length;e<a;e++){let a=t.blocks[e];a._coordinates=scaleCoordinates(a.coordinates,t.mapScale)}}function scalePoints(t){let e=t.blocks;if(t.hasPoint)for(let a=0,s=e.length;a<s;a++){e[a]._point=[];let s=e[a].point.length;for(let n=0;n<s;n++){let s=e[a].point[n];e[a]._point.push({x:s.position.x*t.mapScale,y:s.position.y*t.mapScale,r:s.r,color:s.color})}}}function setColorsHashID(t,e,a=!1){let s=t.colorsHash;for(;;){const t=this.getRandomColor();if(!s[t])return s[t]=e,void(e.hitStyle=new selfStyle({fillStyle:a?"rgba(0,0,0,0)":t}))}}function getRandomColor(){return`rgb(${Math.round(255*Math.random())},${Math.round(255*Math.random())},${Math.round(255*Math.random())})`}function hasSameHashColor(t,e){return e.color===t}function scaleMap(t){let e=this.history.map[this.history.index];this.setMapScale(t),this.translateCtx(e,e.mapTranslateX,e.mapTranslateY),window.requestAnimationFrame(()=>this.drawAllBoundary())}function getLikeGeoJson(t){let e=[];for(let a=0,s=t.length;a<s;a+=2)e.push([t[a],t[a+1]]);return e}function setMirror(t,e,a){if(t.mirror){let s={};t.mirror.horizontal&&(s.x=e.x.end+e.x.start),t.mirror.vertical&&(s.y=e.y.end+e.y.start),a=getMapDataInfo(a,s)}return a}var compute=Object.freeze({setBoundary:setBoundary,setBlocks:setBlocks,setTextName:setTextName,getPoints:getPoints,setMapScale:setMapScale,scaleBoundary:scaleBoundary,scaleBlocks:scaleBlocks,scalePoints:scalePoints,setColorsHashID:setColorsHashID,getRandomColor:getRandomColor,hasSameHashColor:hasSameHashColor,scaleMap:scaleMap,getLikeGeoJson:getLikeGeoJson});function drawAllBoundary(){let t=this.history.map[this.history.index];this.clearCanvasCtx(),this.drawBlockBoundary(t),this.drawMainBoundary(t),this.drawBlockPoints(t),this.drawBlockText(t),this.ctx.setTransform(1,0,0,1,0,0),this.hitCtx.setTransform(1,0,0,1,0,0)}function drawBoundary(t){let e=t.style,a=e.fillStyle,s={};s={fillStyle:a=t.hold?e.holdColor||a:t.over?e.hoverColor:a,lineWidth:e.lineWidth,strokeStyle:e.strokeStyle};for(let e=0,a=t._coordinates.length;e<a;e++)this.drawLine(this.ctx,t._coordinates[e],s),this.drawLine(this.hitCtx,t._coordinates[e],t.hitStyle)}function drawMainBoundary(t){this.drawBoundary(t.boundary)}function drawBlockBoundary(t){let e=t.blocks.length;for(let a=0;a<e;a++)this.drawBoundary(t.blocks[a])}function drawArc(t,e,a){(t=this.setCtxState(a,t)).arc(e.x,e.y,e.r,e.s,e.e,e.d),t.fill(),t.closePath(),t.restore()}function drawBlockText(t,e=this.ctx){let a=this.options.map.blocks.cityName;if(!a)return;let s=t.blocks,n=a.move||{x:0,y:0};for(let i=0,o=s.length;i<o;i++){let o=s[i],r=!1,l=o.width*t.mapScale,h=e.measureText(o.name).width;if(o.name&&(o.hold?r=o.nameStyle.hold:o.over&&(r=o.nameStyle.hover),r||(r=o.nameStyle.normal),h<l/this.textVsWidth||o.index===t.mouseMoveIndex)){let s=o.centroid.x*t.mapScale+n.x,i=o.centroid.y*t.mapScale+n.y;e.save(),e.shadowColor="rgba(128, 128, 128, .8)",e.shadowOffsetX=this.DPI,e.shadowOffsetY=this.DPI,this.drawText({txt:o.name,x:s,y:i,align:a.align},r,e),e.restore()}}}function drawText(t,e,a=this.ctx){let{txt:s,x:n,y:i,align:o}=t;a.save(),(a=this.setCtxState(e,a)).textAlign=o||"center",a.textBaseline="middle",a.fillText(s,n,i),a.restore()}function drawCenterLine(){this.ctx.beginPath(),this.ctx.strokeStyle="red",this.ctx.moveTo(0,this.ctxH/2),this.ctx.lineTo(this.ctxW,this.ctxH/2),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle="red",this.ctx.moveTo(this.ctxW/2,0),this.ctx.lineTo(this.ctxW/2,this.ctxH),this.ctx.stroke()}function drawBlockPoints(t){const e=t.blocks;if(!t.hasPoint)return t;for(let a=0,s=e.length;a<s;a++){let s=e[a].width*t.mapScale;e[a]._point.forEach(t=>{s>5*t.r&&this.drawArc(this.ctx,{x:t.x,y:t.y,r:t.r,s:0,e:2*Math.PI,d:!1},{fillStyle:t.color})})}}function drawLine(t,e,a){t=this.setCtxState(a,t);for(let a=0,s=e.length;a<s;a++){let s=e[a][0],n=e[a][1];0===a?t.moveTo(s,n):t.lineTo(s,n)}return t.lineJoin="round",t.closePath(),t.stroke(),t.fill(),t}function translateCtx(t,e=0,a=0){let s=(this.ctxW-t.boundary.width*t.mapScale)/2+e,n=(this.ctxH-t.boundary.height*t.mapScale)/2+a;this.clearCanvasCtx(),this.ctx.translate(s,n),this.hitCtx.translate(s,n)}var draw=Object.freeze({drawAllBoundary:drawAllBoundary,drawBoundary:drawBoundary,drawMainBoundary:drawMainBoundary,drawBlockBoundary:drawBlockBoundary,drawArc:drawArc,drawBlockText:drawBlockText,drawText:drawText,drawCenterLine:drawCenterLine,drawBlockPoints:drawBlockPoints,drawLine:drawLine,translateCtx:translateCtx});class History{constructor(){this.map=[],this.index=0}go(t){let e=this.constructor.history,a=e.map.length;if(isNaN(t))return console.warn("val is not a Number");if(!(t=parseInt(t)))return;let s=e.index,n=a-1;s+=t,s=t>0?s>n?s=n:s:s<0?0:s,this.constructor.zoomOut(),this.constructor.history.index=s,setTimeout(()=>{this.constructor.fadeIn()},1e3)}back(){let t=this.constructor.history.index;t&&(this.constructor.fadeOut(),this.constructor.history.index=t-1>0?t-1:0,setTimeout(()=>{this.constructor.zoomIn()},1e3))}forward(){let t=this.constructor.history,e=t.index;(e+=1)>=t.map.length||(this.constructor.history.index=e,this.constructor.zoomOut(),setTimeout(()=>{this.constructor.fadeIn()},1e3))}push({boundary:t,blocks:e,key:a,usrData:s}=opt){let n=this.constructor,i=n.history,o=()=>{let o=n.options.map;o.boundary.data=t,o.blocks.data=e,n.options.usrData=s||{},n.setMapData(),i.map[i.index].parentID=a};n.zoomOut(),i.index+=1;let r=i.map[i.index];r?r.parentID!==a&&(i.map.length=i.index,o()):o(),setTimeout(()=>{n.fadeIn()},1e3)}}function setHistory(){this.history=new this.History,this.history.__proto__.constructor=this}var history=Object.freeze({History:History,setHistory:setHistory});const myCmap={...event,...init$1,...animate,...canvas,...compute,...draw,...style,...history};class CMap{constructor(t){this.options=t,this.DPI=window.devicePixelRatio,this.mainCanvas=null,this.ctx=null,this.hitCtx=null,this.ctxW=0,this.ctxH=0,this.inAnimate=!1,this.textVsWidth=2}}Object.keys(myCmap).forEach(t=>{Object.defineProperty(CMap.prototype,t,{value:myCmap[t]})});export default CMap;
//# sourceMappingURL=CMap.min.js.map
